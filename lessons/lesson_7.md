# Занятие 7

Работа с реляционными БД (на примере PostgreSQL)  
 - PostgreSQL - самая популярная реляционная база данных  
 - Связывание базы данных с концепциями объектно-ориентированных языков программирования с помощью ORM  
 - Настройка и запуск собственной базы данных PostgreSQL на локальном сервере  
 - Практика написания SQL-запросов  



## Реляционная БД

### Термины
- тип данных. Аналогия типа данных из ЯП
- ячейка. Минимальная единица данных. Аналог переменой из ЯП.
- колонка. Набор ячеек одного типа.
- запись. Набор ячеек экземпляра одной сущности.
- таблица. Набор записей.
- запрос. Текс определеной структуры (SQL), описывающий команду для обработки данных. Разные типы команд имеют разных синтаксис и могут как возвращать результат (таблицу), так и нет
- драйвер. Как правило, бд имеет бинарный протокол, используя который можно общаться с бд (отправлять запросы и получать в ответ данные). Аналог драйвера в ОС
- ORM. Объектно-ориентированная модель. Способ работы с данными релиационной бд как с экземплярами объектов/классов определённой схемы (стуктуры).

Таблица с данными пользователей
|  id | username |   email   |      dateCreate     |
|:---:|:--------:|:---------:|:-------------------:|
| 345 | Паша     | p@mail.ru | 2006-01-11 07:56:20 |
| 346 | Саня     | s@mail.ru | 2018-08-13 19:17:04 |
| 347 | Димарик  | d@mail.ru | 2018-08-14 00:14:12 |


Эти же данные на стороне NodeJS:
```js
[
  {
    id: 345,
    username: 'Паша',
    email: 'p@mail.ru',
    dateCreate: '2006-01-11 07:56:20'
  },
  {
    id: 346,
    username: 'Саня',
    email: 's@mail.ru',
    dateCreate: '2018-08-13 19:17:04'
  },
  {
    id: 347,
    username: 'Димарик',
    email: 'd@mail.ru',
    dateCreate: '2018-08-14 00:14:12'
  }
]
```

### Установка
Будем использовать [MariaDb](https://mariadb.com/kb/en/library/installing-and-using-mariadb-via-docker/) - форк знаменийто MySQL.


Скачиваем образ последней стабильной версии
```sh
docker pull mariadb:latest
```


Запускаем контейнер командой
```sh
docker run --restart=always –name mariadb_test -v /mnt/mysql:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD='mypass' -p 3306:3306 -d mariadb –innodb_buffer_pool_size=1G
```
Что тут написано
* запустить контейнер c именем `mariadb_test`
* рестартовать контейнер при выключении системы `–restart=always`
* проброс директории в контейнер, чтобы при перезапуске контейнера не потерять данные в контейнере `-v /mnt/mysql:/var/lib/mysql`
* сразу задаем пароль `-e MYSQL_ROOT_PASSWORD='mypass'`
* указываем порт, по которому будет снаружи доступна база `-p 3306:3306`. Первая цифра 3306 - это мы используем для доступа снаружи контейнера, например указываем в драйвере в NodeJS. Второй порт 3306 - база должна слушать внутри контейнера. Т.е. мы можем запустить хоть 10 контейнеров с базой и они будут прекрасно работать.
* запусить в режиме демона `-d`
* имя образа `mariadb`. Можно указать конкретную версию базы через `:`
* опция уже самого процесса базы `-innodb_buffer_pool_size=1G`. Т.е. уже при запуске контейнера можно указывать настройки запуска и не нужно лезь внутрь контейнера


### Подключение через консоль
Выполнив команду
```bash
mysql -uroot --password -p 3306
```
мы попадаем в режим командой строки уже самой базы. Как будто запустили интерпретатор NodeJS, только для базы данных


### Подключение через NodeJs
Будем использовать [mysql](https://github.com/mysqljs/mysql) - одноименный драйвер:

```bash
npm i --save mysql
```

Создадим файл `model/db.js` со следующим содержимым:
```js
const mysql      = require('mysql');

const connection = mysql.createConnection({
  host     : 'localhost',
  user     : 'me',
  password : 'secret',
  database : 'my_db'
});

connection.connect();

connection.query('SELECT 1 + 1 AS solution', function (error, results, fields) {
  if (error) throw error;
  console.log('The solution is: ', results[0].solution);
});

connection.end();
```





