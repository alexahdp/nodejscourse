# Занятие 7

## Теоретическая часть
 - что такое базы данных и для чего их стоит использовать  
 - какие бывают базы данных (key-value, реляционные, sql/nosql, графовые, колоночные)  
 - SQL-базы данных: mysql, mariadb, postrgres (основные отличия)  
 - синтаксис SQL (очень коротко)  
 - ORM  
 - разработка схемы данных  
 - валидация данных  


### Основные Термины
- тип данных. Аналогия типа данных из ЯП
- ячейка. Минимальная единица данных. Аналог переменной из ЯП.
- колонка. Набор ячеек одного типа.
- запись. Набор ячеек экземпляра одной сущности.
- таблица. Набор записей.
- запрос. Текс определеной структуры (SQL), описывающий команду для обработки данных. Разные типы команд имеют разных синтаксис и могут как возвращать результат (таблицу), так и нет
- драйвер. Как правило, бд имеет бинарный протокол, используя который можно общаться с бд (отправлять запросы и получать в ответ данные). Аналог драйвера в ОС
- ORM. Объектно-ориентированная модель. Способ работы с данными релиационной бд как с экземплярами объектов/классов определённой схемы (стуктуры).

Пример таблицы с данными пользователей:  

|  id | username |   email   |      dateCreate     |
|---|---|---|---|
| 345 | Bob     | p@mail.ru | 2006-01-11 07:56:20 |
| 346 | Alice     | s@mail.ru | 2018-08-13 19:17:04 |
| 347 | Mark  | d@mail.ru | 2018-08-14 00:14:12 |


Эти же данные на стороне NodeJS в виде объектов:
```js
[
  {
    id: 345,
    username: 'Bob',
    email: 'p@mail.ru',
    dateCreate: '2006-01-11 07:56:20'
  },
  {
    id: 346,
    username: 'Alice',
    email: 's@mail.ru',
    dateCreate: '2018-08-13 19:17:04'
  },
  {
    id: 347,
    username: 'Mark',
    email: 'd@mail.ru',
    dateCreate: '2018-08-14 00:14:12'
  }
]
```

### GUI
Работать с БД через консоль можно, но можно использовать графическое приложение [HeidiSQL ](https://www.heidisql.com/)

## Практическая часть

### Установка
В качестве sql-базы данных будем использовать [MariaDB](https://mariadb.com/kb/en/library/installing-and-using-mariadb-via-docker/)  

Скачиваем образ последней стабильной версии через docker
```sh
docker pull mariadb:latest
```

Запускаем контейнер командой
```sh
docker run --restart=always --name mariadb_test -v /mnt/mysql:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD='mypass' -p 3306:3306 -d mariadb -innodb_buffer_pool_size=1G
```
Что тут написано:
* запустить контейнер c именем `mariadb_test`
* рестартовать контейнер при выключении системы `–restart=always`
* проброс директории в контейнер, чтобы при перезапуске контейнера не потерять данные в контейнере `-v /mnt/mysql:/var/lib/mysql`
* сразу задаем пароль `-e MYSQL_ROOT_PASSWORD='mypass'`
* указываем порт, по которому будет снаружи доступна база `-p 3306:3306`. Первая цифра 3306 - это мы используем для доступа снаружи контейнера, например указываем в драйвере в NodeJS. Второй порт 3306 - база должна слушать внутри контейнера. Т.е. мы можем запустить хоть 10 контейнеров с базой и они будут прекрасно работать.
* запусить в режиме демона `-d`
* имя образа `mariadb`. Можно указать конкретную версию базы через `:`
* опция уже самого процесса базы `-innodb_buffer_pool_size=1G`. Т.е. уже при запуске контейнера можно указывать настройки запуска и не нужно лезь внутрь контейнера


### Подключение через консоль
Внутри docker-контейнера с mysql нужно выполнить команду:
```bash
mysql -uroot --password -p 3306 --protocol=TCP
```
после этого мы попадаем в режим командой строки mysql. Как будто запустили интерпретатор NodeJS, только для базы данных. 


### Подключение через NodeJs
Будем использовать [mysql](https://github.com/mysqljs/mysql) - одноименный драйвер:

```bash
npm i --save mysql
```

Создадим файл `model/db.js` со следующим содержимым:
```js
const mysql      = require('mysql');

const sql = mysql.createConnection({
  host     : configl.db.host,
  user     : configl.db.user,
  password : configl.db.password,
  database : configl.db.database
});

sql.connect();

module.exports = { sql };
```

Теперь в любом месте проекта пишем:
```javascript
const { sql } = require('model/db');
sql.query('SELECT 1 + 1 AS solution', function (error, results, fields) {
  if (error) throw error;
  console.log('The solution is: ', results[0].solution);
});
```

### Пулл коннектор
Код создания коннекта из предыдущего примера имеет существенные ограничения:
  параметры подключения захардкожены в файле, нет закрытия коннекта, нельзя делать несколько одновременных запросов. Это легко исправляется путем изменений конфига подключения к БД:
```javascript
const mysql      = require('mysql');
var sql  = mysql.createPool({
  connectionLimit : 10,
  host     : configl.db.host,
  user     : configl.db.user,
  password : configl.db.password,
  database : configl.db.database
});

module.exports = { sql };
```
(поле connectionLimit)

Теперь при вызове pool.query будут вызваны несколько действий:
* sql.getConnection(). Он получит объект connection из пулла коннектов. Если свободных коннектор нет, будет ждать пока появится.
* connection.query(). Собвственно выполнение запроса
* connection.release(). Освобождение запроса и пометка его в пулле коннектов как свободного.
Для пользователя это всё скрыто и можно использовать sql.query
Полный список настроек [тут](https://github.com/mysqljs/mysql#pool-options)


### Примеры sql-запросов

1. получение данных
```sql
SELECT email, username, dateCreate FROM users WHERE email = 'd@mail.ru'
SELECT SUBSTRING_INDEX(email, '@', -1) AS domain, COUNT(*) AS count FROM users GROUP BY domain ORDER BY count DESC LIMIT 5
```
2. изменение данных
```sql
DELETE FROM users WHERE email LIKE '%@mail.ru%'
ALTER TABLE users ADD COLUMN phone VARCHAR(15) AFTER username;
```

### Построитель запросов
Как правило, запрос должен содержать некоторые данные полученные извне

```javascript
// где-то в коде
const email = req.query.email;

sql.query(`SELECT * FROM users WHERE email = ${email}`, ...;
```
Такой подход хорош всем, кроме безопасности. Самым частым случаем взлома веб-приложений является передача от клиента параметров, изменяющих поведение sql-запроса на вредоносное. Чтобы "руками" каждый раз не проверять, что же пришло от клиента, в драйвер встроен механизм "очистки" данных от возможных проблем:
```javascript
sql.query(
  'SELECT * FROM users WHERE email = ? AND username = ?',
 email,
 username
  function (error, results) {
    
  }
);
```
При выполнении запроса драйвер вызовет метод `connection.escape()` и очистит значение от возможного вредоносного содержимого.

Для удобства составления запросов можно и нужно использовать постоитель запросов [squel](hiddentao.com/squel)
```javascript
let s = squel.select()
        .field("*")
        .from("users")
        .where("email = ?", email)
        .where("username = ?", username);
        
sql.query(s.toString(), ...)
```

### Задание 1
Добавить создание подключения в проект. Код подключения должен располагаться в отдельном файле. Перенести запуск mysql в docker-контейнере в docker-compose файл.

### Задание 2
Изменить код авторизации и регистрации так, чтобы данные о пользователе хранились в БД.
Должна быть таблица users. В этой таблице должны быть следующие поля:
# TODO разобраться с типами полей
 - id  
 - email (unique)  
 - password  
 - createdAt  
 - updatedAt  
 - emailVerified (Boolean)  
 - firstName  
 - lastName  

При разработке api нужно учитывать следующие факты:
 - при регистрации пользователь с указанным email может уже существовать в базе  
 - пользователь может попытаться ввести некорректный email  
 - firstName и lastName не должны быть пустыми  
 - при регистрации нового пользователя нужно отправлять на его email письмо о подтверждении  
 - до тех пор, пока пользователь не подтвердит свой email, его нельзя авторизовывать  
 - должна быть отдельная страница с формой "Забыли пароль?"  
 - количество пользователей будет большим и поиск пользователей будет выполняться по email  
 - должна быть bin-команда для верификации пользователей, пример использования:
```js
bin/user.js verify --email bob@gmail.com
```


## Homework

### Задание 1
# TODO придумать задачцу
задача должна быть не слишком большой
это должен быть некий api, у которого были бы операции CRUD
Написать API, который бы позволял ...
